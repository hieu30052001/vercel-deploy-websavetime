<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="public/styles.css">
    <title>Lưu trữ thời gian bảo trì</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #errorInput { display: none; margin-top: 10px; }
        button { margin: 10px 0; padding: 10px 20px; }
        #currentTime { margin-top: 20px; font-weight: bold; }
        textarea { width: 100%; height: 80px; margin-top: 5px; }
        #historySection { margin-top: 20px; }
        #historyTable { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #historyTable th, #historyTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #historyTable th { background-color: #f2f2f2; }
        #historyTable tr:nth-child(even) { background-color: #f9f9f9; }
        #historyTable tr:hover { background-color: #f5f5f5; }
        .deleteButton { background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .deleteButton:hover { background-color: #cc0000; }
    </style>
</head>
<body>
    <header>
        <img src="/public/logo.png" alt="Nhựa Tân Phú" id="logo">
    </header>
    
    <datalist id="listOfError">
        <option value="Sọc màng">
        <option value="Màng Dày + Màng Mỏng">
        <option value="Tróc hình in">
        <!-- Các option khác giữ nguyên như mã gốc, không lặp lại để tiết kiệm không gian -->
    </datalist>
    
    <h1>Lưu Thời Gian</h1>
    <div id="loginSection">
        <label for="username">Tên đăng nhập:</label>
        <input type="text" id="username" placeholder="Nhập tên đăng nhập">
        <br>
        <label for="password">Mật khẩu:</label>
        <input type="password" id="password" placeholder="Nhập mật khẩu">
        <br>
        <button id="loginButton">Đăng nhập</button>
    </div>
    <div id="mainSection" style="display: none;">
        <label for="ca"><span class="highlight-red">B1</span>Ca:</label>
        <select id="ca">
            <option value="A">Ca A</option>
            <option value="B">Ca B</option>
        </select>
        <div>
            <label for="machineName">Tên máy:</label>
            <input type="text" id="machineName" placeholder="Nhập tên máy">
        </div>
        <div id="longTimeSection">
            <label for="longTimeInput"><span class="highlight-red">B2</span>Nhập thời gian xử lý lỗi (phút):</label>
            <input type="number" id="longTimeInput" placeholder="Thời gian (phút)">
            <button id="saveLongTimeButton">Lưu thời gian</button>
        </div>
        <div id="errorInput" style="display: none;">
            <label for="error"><span class="highlight-red">B3</span>Tên lỗi:</label>
            <input type="text" id="error" list="listOfError" placeholder="Nhập lỗi">
            <label for="solution"><span class="highlight-red">B4</span>Hướng khắc phục:</label>
            <textarea id="solution" placeholder="Nhập hướng khắc phục"></textarea>
            <button id="submitError"><span class="highlight-red">B5</span>Lưu</button>
        </div>
        <div id="currentTime">Thời gian hiện tại: --:--:--</div>
        <button id="logoutButton">Đăng xuất</button>
        <div id="historySection">
            <h2>Lịch sử dữ liệu</h2>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Thời gian bắt đầu</th>
                        <th>Tên máy</th>
                        <th>Lỗi</th>
                        <th>Thời gian xử lý (phút)</th>
                        <th>Hướng khắc phục</th>
                        <th>Ca</th>
                        <th>Người nhập</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let elapsedMinutes;

        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const errorInput = document.getElementById('errorInput');
        const usernameInput = document.getElementById('username');
        const caInput = document.getElementById('ca');
        const passwordInput = document.getElementById('password');
        const submitErrorButton = document.getElementById('submitError');
        const currentTimeDisplay = document.getElementById('currentTime');
        const longTimeInput = document.getElementById('longTimeInput');
        const saveLongTimeButton = document.getElementById('saveLongTimeButton');
        const machineNameInput = document.getElementById('machineName');
        const solutionInput = document.getElementById('solution');
        const historyTableBody = document.getElementById('historyTableBody');

        // Danh sách tài khoản hợp lệ
        const VALID_CREDENTIALS = [
            { username: 'C17', password: '1234' },
            { username: 'C18', password: '1234' },
            { username: 'C19', password: '1234' },
            { username: 'C20', password: '1234' },
            { username: 'A21', password: '1234' },
            { username: 'A22', password: '1234' },
            { username: 'A23', password: '1234' },
            { username: 'A24', password: '1234' },
            { username: 'C1x4', password: '1234' },
            { username: 'C2x4', password: '1234' },
            { username: 'C3x4', password: '1234' },
            { username: 'C4x4', password: '1234' },
            { username: 'C5x4', password: '1234' },
            { username: 'hieu', password: '1234' }
        ];

        // Khởi tạo ca
        function updateShift() {
            caInput.value = 'A'; // Mặc định chọn ca A
        }
        updateShift();

        // Cập nhật thời gian thực
        function updateTime() {
            const now = new Date();
            const vietnamTime = new Date(now.getTime() + 7 * 60 * 60 * 1000);
            const formattedTime = vietnamTime.toISOString().slice(11, 19);
            currentTimeDisplay.innerText = `Thời gian hiện tại: ${formattedTime}`;
        }
        setInterval(updateTime, 1000);

        // Lưu trạng thái vào localStorage
        function saveState() {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('username', usernameInput.value.trim());
            localStorage.setItem('ca', caInput.value);
            localStorage.setItem('machineName', machineNameInput.value.trim());
        }

        // Tải trạng thái từ localStorage
        function loadState() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const savedUsername = localStorage.getItem('username');
            const savedCa = localStorage.getItem('ca');
            const savedMachineName = localStorage.getItem('machineName');

            if (isLoggedIn) {
                loginSection.style.display = 'none';
                mainSection.style.display = 'block';
                usernameInput.value = savedUsername || '';
                caInput.value = savedCa || 'A';
                machineNameInput.value = savedMachineName || '';
                fetchHistory(); // Tải lịch sử khi đăng nhập
            }
        }

        // Xóa trạng thái khi đăng xuất
        function clearState() {
            localStorage.clear();
        }

        // Đăng nhập
        loginButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const validUser = VALID_CREDENTIALS.find(
                cred => cred.username === username && cred.password === password
            );
            if (validUser) {
                alert('Đăng nhập thành công!');
                loginSection.style.display = 'none';
                mainSection.style.display = 'block';
                saveState();
                fetchHistory(); // Tải lịch sử sau khi đăng nhập
            } else {
                alert('Sai tên đăng nhập hoặc mật khẩu!');
            }
        });

        // Lưu thời gian dài
        saveLongTimeButton.addEventListener('click', () => {
            const ca = caInput.value;
            const longTimeValue = parseFloat(longTimeInput.value);
            if (!ca) {
                alert('Vui lòng chọn ca.');
                return;
            }
            if (!longTimeValue || longTimeValue <= 0) {
                alert('Vui lòng nhập thời gian lỗi hợp lệ (phút).');
                return;
            }
            elapsedMinutes = longTimeValue;
            alert(`Thời gian lỗi: ${elapsedMinutes} phút`);
            errorInput.style.display = 'block';
            saveState();
        });

        // Đăng xuất
        logoutButton.addEventListener('click', () => {
            clearState();
            mainSection.style.display = 'none';
            loginSection.style.display = 'block';
            historyTableBody.innerHTML = ''; // Xóa bảng lịch sử khi đăng xuất
        });

        // Lấy dữ liệu lịch sử từ API
        async function fetchHistory() {
            try {
                const response = await fetch('https://vercel-deploy-websavetime.vercel.app/api/back');
                if (response.ok) {
                    const data = await response.json();
                    renderHistory(data);
                } else {
                    alert('Không thể tải lịch sử.');
                }
            } catch (error) {
                alert('Lỗi kết nối khi tải lịch sử.');
            }
        }

        // Hiển thị dữ liệu lịch sử trong bảng
        function renderHistory(data) {
            historyTableBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                const startTime = new Date(item.startTime).toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
                row.innerHTML = `
                    <td>${startTime}</td>
                    <td>${item.machineName}</td>
                    <td>${item.error}</td>
                    <td>${item.errorDuration}</td>
                    <td>${item.solution}</td>
                    <td>${item.ca}</td>
                    <td>${item.username}</td>
                    <td><button class="deleteButton" data-id="${item._id}">Xóa</button></td>
                `;
                historyTableBody.appendChild(row);
            });

            // Thêm sự kiện cho các nút xóa
            document.querySelectorAll('.deleteButton').forEach(button => {
                button.addEventListener('click', async () => {
                    const id = button.getAttribute('data-id');
                    if (confirm('Bạn có chắc muốn xóa bản ghi này?')) {
                        await deleteRecord(id);
                    }
                });
            });
        }

        // Xóa bản ghi
        async function deleteRecord(id) {
            try {
                const response = await fetch(`https://vercel-deploy-websavetime.vercel.app/api/back/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Xóa bản ghi thành công.');
                    fetchHistory(); // Tải lại lịch sử sau khi xóa
                } else {
                    alert('Không thể xóa bản ghi.');
                }
            } catch (error) {
                alert('Lỗi kết nối khi xóa bản ghi.');
            }
        }

        // Lưu lỗi
        submitErrorButton.addEventListener('click', async () => {
            submitErrorButton.disabled = true;
            const errorName = document.getElementById('error').value.trim();
            const machineName = machineNameInput.value.trim();
            const solution = solutionInput.value.trim();
            if (!errorName) {
                alert('Vui lòng nhập tên lỗi.');
                submitErrorButton.disabled = false;
                return;
            }
            if (!machineName) {
                alert('Vui lòng nhập tên máy.');
                submitErrorButton.disabled = false;
                return;
            }
            if (!solution) {
                alert('Vui lòng nhập hướng khắc phục.');
                submitErrorButton.disabled = false;
                return;
            }
            if (!elapsedMinutes) {
                alert('Vui lòng lưu thời gian lỗi trước khi lưu lỗi.');
                submitErrorButton.disabled = false;
                return;
            }

            const vietnamStartTime = new Date();
            const vietnamEndTime = new Date(vietnamStartTime.getTime() + elapsedMinutes * 60 * 1000);

            const data = {
                username: usernameInput.value,
                ca: caInput.value,
                machineName: machineName,
                startTime: vietnamStartTime.toISOString(),
                endTime: vietnamEndTime.toISOString(),
                error: errorName,
                errorDuration: parseFloat(elapsedMinutes),
                solution: solution
            };
            try {
                const response = await fetch('https://vercel-deploy-websavetime.vercel.app/api/back', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    alert('Lưu dữ liệu thành công.');
                    errorInput.style.display = 'none';
                    machineNameInput.value = machineName;
                    longTimeInput.value = '';
                    solutionInput.value = '';
                    elapsedMinutes = null;
                    fetchHistory(); // Tải lại lịch sử sau khi lưu
                } else {
                    alert('Đã xảy ra lỗi khi lưu.');
                }
            } catch (error) {
                alert('Lỗi kết nối hoặc máy chủ.');
            } finally {
                submitErrorButton.disabled = false;
            }
        });

        // Tải trạng thái khi trang tải
        loadState();
    </script>
</body>
</html>
